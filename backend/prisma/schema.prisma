// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  DOCTOR
  RECEPTIONIST
  STAFF
}

enum AppointmentStatus {
  SCHEDULED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum DocumentType {
  XRAY
  REPORT
  PHOTO
  OTHER
}

enum InventoryTransactionType {
  PURCHASE
  SALE
  ADJUSTMENT
  USAGE
  EXPIRED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  role          UserRole @default(STAFF)
  firstName     String
  lastName      String
  phone         String?
  isActive      Boolean  @default(true)
  lastLogin     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  appointments  Appointment[]
  treatments    Treatment[]
  prescriptions Prescription[]
  invoices      Invoice[]
  attendance    Attendance[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
}

model Patient {
  id                String   @id @default(uuid())
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            String
  phone             String
  email             String?
  address           String?
  city              String?
  state             String?
  pincode           String?
  emergencyContact  String?
  emergencyPhone    String?
  medicalHistory    String?  @db.Text
  allergies         String?
  bloodGroup        String?
  occupation        String?
  referredBy        String?
  notes             String?  @db.Text
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  appointments      Appointment[]
  treatments        Treatment[]
  prescriptions     Prescription[]
  invoices          Invoice[]
  documents         Document[]
  payments          Payment[]

  @@index([phone])
  @@index([email])
  @@index([firstName, lastName])
}

model Appointment {
  id          String            @id @default(uuid())
  patientId   String
  doctorId    String?
  chairNumber Int               @default(1)
  startTime   DateTime
  endTime     DateTime
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?           @db.Text
  checkedInAt DateTime?
  checkedOutAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  patient     Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor      User?             @relation(fields: [doctorId], references: [id])
  treatments  Treatment[]
  invoices    Invoice[]

  @@index([patientId])
  @@index([doctorId])
  @@index([startTime])
  @@index([status])
  @@index([chairNumber, startTime])
}

model Treatment {
  id              String   @id @default(uuid())
  patientId       String
  appointmentId   String?
  doctorId        String
  toothNumber     String?  // FDI notation
  treatmentType   String
  description     String   @db.Text
  clinicalNotes   String?  @db.Text
  treatmentDate   DateTime @default(now())
  status          String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  outcome         String?  @db.Text
  cost            Decimal  @default(0) @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment     Appointment? @relation(fields: [appointmentId], references: [id])
  doctor          User     @relation(fields: [doctorId], references: [id])
  invoiceItems    InvoiceItem[]
  inventoryUsage  InventoryTransaction[]

  @@index([patientId])
  @@index([appointmentId])
  @@index([doctorId])
  @@index([treatmentDate])
}

model Prescription {
  id          String   @id @default(uuid())
  patientId   String
  doctorId    String
  date        DateTime @default(now())
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor      User     @relation(fields: [doctorId], references: [id])
  items       PrescriptionItem[]

  @@index([patientId])
  @@index([doctorId])
  @@index([date])
}

model PrescriptionItem {
  id             String       @id @default(uuid())
  prescriptionId String
  medicationName String
  dosage         String
  frequency      String
  duration       String
  instructions   String?     @db.Text
  createdAt      DateTime     @default(now())

  // Relations
  prescription   Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
}

model Invoice {
  id              String        @id @default(uuid())
  invoiceNumber   String        @unique
  patientId       String
  appointmentId   String?
  issuedBy        String
  issueDate       DateTime      @default(now())
  dueDate         DateTime?
  subtotal        Decimal       @default(0) @db.Decimal(10, 2)
  taxRate         Decimal       @default(18) @db.Decimal(5, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @default(0) @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @db.Decimal(10, 2)
  status          PaymentStatus @default(PENDING)
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  patient         Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointment     Appointment?  @relation(fields: [appointmentId], references: [id])
  issuer          User          @relation(fields: [issuedBy], references: [id])
  items           InvoiceItem[]
  payments        Payment[]

  @@index([patientId])
  @@index([appointmentId])
  @@index([invoiceNumber])
  @@index([issueDate])
  @@index([status])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  treatmentId String?
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  // Relations
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  treatment   Treatment? @relation(fields: [treatmentId], references: [id])

  @@index([invoiceId])
  @@index([treatmentId])
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String
  patientId     String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  transactionId String?
  reference     String?
  notes         String?       @db.Text
  paymentDate   DateTime      @default(now())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  invoice       Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  patient       Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([patientId])
  @@index([paymentDate])
}

model Inventory {
  id              String   @id @default(uuid())
  name            String
  description     String?  @db.Text
  category        String
  unit            String   // e.g., "pieces", "ml", "kg"
  currentStock    Decimal  @default(0) @db.Decimal(10, 2)
  minStockLevel   Decimal  @default(0) @db.Decimal(10, 2)
  maxStockLevel   Decimal? @db.Decimal(10, 2)
  unitPrice       Decimal? @db.Decimal(10, 2)
  expiryDate      DateTime?
  supplier        String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  transactions    InventoryTransaction[]

  @@index([category])
  @@index([name])
}

model InventoryTransaction {
  id            String                    @id @default(uuid())
  inventoryId   String
  treatmentId   String?
  type          InventoryTransactionType
  quantity      Decimal                   @db.Decimal(10, 2)
  unitPrice     Decimal?                  @db.Decimal(10, 2)
  totalAmount   Decimal?                  @db.Decimal(10, 2)
  notes         String?                   @db.Text
  transactionDate DateTime                @default(now())
  createdAt     DateTime                  @default(now())

  // Relations
  inventory     Inventory                 @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  treatment     Treatment?                @relation(fields: [treatmentId], references: [id])

  @@index([inventoryId])
  @@index([treatmentId])
  @@index([type])
  @@index([transactionDate])
}

model Attendance {
  id          String   @id @default(uuid())
  userId      String
  date        DateTime @default(now())
  clockIn     DateTime?
  clockOut    DateTime?
  breakStart  DateTime?
  breakEnd    DateTime?
  totalHours  Decimal? @db.Decimal(5, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model Document {
  id          String       @id @default(uuid())
  patientId   String
  type        DocumentType
  fileName    String
  filePath    String
  fileSize    Int
  mimeType    String
  description String?      @db.Text
  uploadedBy  String?
  uploadedAt  DateTime     @default(now())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([type])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  entityType  String
  entityId    String?
  details     String?  @db.Text
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model ClinicSettings {
  id              String   @id @default(uuid())
  clinicName      String   @default("Mahesh Superspecialty Dental Clinic")
  address         String   @default("Ashok Nagar, Ganjipeta, Krishna Nagar, Gadwal-509125, Telangana")
  phone           String?
  email           String?
  currency        String   @default("INR")
  taxRate         Decimal  @default(18) @db.Decimal(5, 2)
  gstNumber       String?
  upiId           String?
  bankDetails     String?  @db.Text
  workingHours    String?  @db.Text
  chairCount      Int      @default(3)
  slotDuration    Int      @default(15) // minutes
  allowOverlap    Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
